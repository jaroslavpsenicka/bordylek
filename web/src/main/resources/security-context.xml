<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns="http://www.springframework.org/schema/security"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
	xmlns:beans="http://www.springframework.org/schema/beans"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:oauth="http://www.springframework.org/schema/security/oauth2"
	xsi:schemaLocation="http://www.springframework.org/schema/beans 
		http://www.springframework.org/schema/beans/spring-beans-3.2.xsd 
		http://www.springframework.org/schema/security 
		http://www.springframework.org/schema/security/spring-security-3.2.xsd
		http://www.springframework.org/schema/security/oauth2 
        http://www.springframework.org/schema/security/spring-security-oauth2-1.0.xsd">

	<global-method-security pre-post-annotations="enabled">
		<expression-handler ref="expressionHandler" />
	</global-method-security>
	
	<http auto-config="true" use-expressions="true" 
	    access-decision-manager-ref="accessDecisionManager"
        entry-point-ref="oauthAuthenticationEntryPoint">
	    <http-basic />
        <custom-filter ref="resourceServerFilter" before="PRE_AUTH_FILTER" />
   	</http>
	
	<beans:bean id="accessDecisionManager" class="org.springframework.security.access.vote.UnanimousBased">
        <beans:constructor-arg>
            <beans:list>
                <beans:bean class="org.springframework.security.oauth2.provider.vote.ScopeVoter" />
                <beans:bean class="org.springframework.security.access.vote.RoleVoter" />
                <beans:bean class="org.springframework.security.access.vote.AuthenticatedVoter" />
            </beans:list>
        </beans:constructor-arg>
    </beans:bean>
	
	<beans:bean id="oauthAuthenticationEntryPoint" class="org.springframework.security.oauth2.provider.error.OAuth2AuthenticationEntryPoint">
        <beans:property name="typeName" value="Basic" />
    </beans:bean>
	
    <authentication-manager>
        <authentication-provider ref="googleAuthenticationProvider"/>
    </authentication-manager>

    <beans:bean id="googleAuthenticationProvider" class="org.bordylek.web.security.CustomAuthenticationProvider"/>
            
    <beans:bean id="expressionHandler" class="org.springframework.security.access.expression.method.DefaultMethodSecurityExpressionHandler">
        <beans:property name="permissionEvaluator" ref="permissionEvaluator"/>
    </beans:bean>

    <beans:bean id="permissionEvaluator" class="org.bordylek.web.security.SimplePermissionEvaluator">
        <beans:property name="ownerEvaluators">
            <beans:list>
                <beans:bean class="org.bordylek.web.security.SimplePermissionEvaluator.UserOwnerEvaluator"/>
            </beans:list>
        </beans:property>
    </beans:bean>
	
	<!-- OAuth -->
	
    <oauth:resource-server id="resourceServerFilter" token-services-ref="tokenServices" />	
    <beans:bean id="tokenServices" class="org.bordylek.web.security.RemoteTokenServices">
        <beans:property name="checkTokenEndpointUrl" value="http://localhost:8080/check" />
        <beans:property name="clientId" value="app" />
        <beans:property name="clientSecret" value="secret" />
    </beans:bean>
    
</beans:beans>